name: Canary Push (Gray Release)

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  canary-push:
    runs-on: ubuntu-latest
    env:
      # Defaults (Day 0 Safe Mode)
      PUSH_MODE: "canary"
      MAX_PUSH_PER_RUN: "10"
      PUSH_PER_TASK_MAX: "2"
      # Kill Switch (Default to true if not set in GitHub Variables)
      CANARY_ENABLED: ${{ vars.CANARY_ENABLED || 'true' }}
      # Secrets
      WECOM_WEBHOOK_CANARY: ${{ secrets.WECOM_WEBHOOK_CANARY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      # Optional: Fallback for old secret name
      WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}

    steps:
      - name: Check Kill Switch
        run: |
          echo "CANARY_ENABLED=${CANARY_ENABLED}"
          if [ "$CANARY_ENABLED" != "true" ]; then
            echo "ðŸ›‘ CANARY_ENABLED is not 'true'. Workflow stopped by Kill Switch."
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run Idempotency Audit
        run: npx tsx scripts/push_idempotency_audit.ts

      - name: Run Canary Push
        run: npx tsx scripts/canary_push.ts
